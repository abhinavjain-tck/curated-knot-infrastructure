name: Terraform CI/CD

# Single-branch architecture: all PRs target main
# Environment is determined by:
# 1. Explicit commands: /plan-dev, /plan-prod, /apply-dev, /apply-prod
# 2. Changed files: environments/development/* or environments/production/*
# 3. If only modules/* changed: runs for BOTH environments

on:
  push:
    branches:
      - main
    paths:
      - 'modules/**'
      - 'environments/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'modules/**'
      - 'environments/**'
      - '.github/workflows/terraform.yml'
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to apply'
        required: true
        type: choice
        options:
          - development
          - production
          - both

concurrency:
  group: terraform-${{ github.ref }}-${{ github.event.inputs.environment || 'auto' }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  TF_VERSION: "1.5.7"

jobs:
  # Check if this is a comment trigger
  check-comment:
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment'
    outputs:
      triggered: ${{ steps.check.outputs.triggered }}
      command: ${{ steps.check.outputs.command }}
      environment: ${{ steps.check.outputs.environment }}
    steps:
      - name: Check for terraform commands
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.trim().toLowerCase();
            const isPR = !!context.payload.issue.pull_request;

            if (!isPR) {
              core.setOutput('triggered', 'false');
              return;
            }

            // Support: /plan, /apply (auto-detect), /plan-dev, /plan-prod, /apply-dev, /apply-prod
            const commands = {
              '/plan-dev': { command: 'plan', environment: 'development' },
              '/plan-prod': { command: 'plan', environment: 'production' },
              '/apply-dev': { command: 'apply', environment: 'development' },
              '/apply-prod': { command: 'apply', environment: 'production' },
              '/plan': { command: 'plan', environment: 'auto' },
              '/apply': { command: 'apply', environment: 'auto' },
            };

            const match = commands[comment];
            if (match) {
              core.setOutput('triggered', 'true');
              core.setOutput('command', match.command);
              core.setOutput('environment', match.environment);
            } else {
              core.setOutput('triggered', 'false');
            }

  # Get PR details for comment triggers
  get-pr-info:
    runs-on: ubuntu-latest
    needs: check-comment
    if: always() && (github.event_name != 'issue_comment' || needs.check-comment.outputs.triggered == 'true')
    outputs:
      ref: ${{ steps.get-info.outputs.ref }}
      pr_number: ${{ steps.get-info.outputs.pr_number }}
    steps:
      - name: Get PR info
        id: get-info
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'issue_comment') {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.issue.number
              });
              core.setOutput('ref', pr.head.ref);
              core.setOutput('pr_number', context.payload.issue.number);
            } else if (context.eventName === 'pull_request') {
              core.setOutput('ref', context.payload.pull_request.head.ref);
              core.setOutput('pr_number', context.payload.pull_request.number);
            } else {
              core.setOutput('ref', context.ref);
              core.setOutput('pr_number', '');
            }

  # Detect which environments need to be processed based on changed files
  detect-environments:
    runs-on: ubuntu-latest
    needs: [check-comment, get-pr-info]
    if: always() && (github.event_name != 'issue_comment' || needs.check-comment.outputs.triggered == 'true')
    outputs:
      environments: ${{ steps.detect.outputs.environments }}
      run_development: ${{ steps.detect.outputs.run_development }}
      run_production: ${{ steps.detect.outputs.run_production }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.get-pr-info.outputs.ref || github.ref }}
          fetch-depth: 0

      - name: Detect environments from changes
        id: detect
        env:
          EXPLICIT_ENV: ${{ needs.check-comment.outputs.environment || github.event.inputs.environment || 'auto' }}
        run: |
          echo "Explicit environment: $EXPLICIT_ENV"

          # If explicit environment specified, use it
          if [[ "$EXPLICIT_ENV" == "development" ]]; then
            echo "environments=[\"development\"]" >> $GITHUB_OUTPUT
            echo "run_development=true" >> $GITHUB_OUTPUT
            echo "run_production=false" >> $GITHUB_OUTPUT
            exit 0
          elif [[ "$EXPLICIT_ENV" == "production" ]]; then
            echo "environments=[\"production\"]" >> $GITHUB_OUTPUT
            echo "run_development=false" >> $GITHUB_OUTPUT
            echo "run_production=true" >> $GITHUB_OUTPUT
            exit 0
          elif [[ "$EXPLICIT_ENV" == "both" ]]; then
            echo "environments=[\"development\",\"production\"]" >> $GITHUB_OUTPUT
            echo "run_development=true" >> $GITHUB_OUTPUT
            echo "run_production=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Auto-detect from changed files
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED_FILES=$(git diff --name-only origin/main..HEAD)
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null || git ls-files)
          else
            # For comment triggers, compare PR branch to main
            CHANGED_FILES=$(git diff --name-only origin/main..HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          DEV_CHANGED=false
          PROD_CHANGED=false
          MODULES_CHANGED=false

          while IFS= read -r file; do
            if [[ "$file" == environments/development/* ]]; then
              DEV_CHANGED=true
            elif [[ "$file" == environments/production/* ]]; then
              PROD_CHANGED=true
            elif [[ "$file" == modules/* ]]; then
              MODULES_CHANGED=true
            fi
          done <<< "$CHANGED_FILES"

          echo "Dev changed: $DEV_CHANGED, Prod changed: $PROD_CHANGED, Modules changed: $MODULES_CHANGED"

          # If modules changed, run for both environments
          if [[ "$MODULES_CHANGED" == "true" ]]; then
            DEV_CHANGED=true
            PROD_CHANGED=true
          fi

          # Build output
          ENVS=()
          if [[ "$DEV_CHANGED" == "true" ]]; then
            ENVS+=("\"development\"")
          fi
          if [[ "$PROD_CHANGED" == "true" ]]; then
            ENVS+=("\"production\"")
          fi

          # If nothing detected, default to development for safety
          if [[ ${#ENVS[@]} -eq 0 ]]; then
            ENVS+=("\"development\"")
            DEV_CHANGED=true
          fi

          ENV_JSON=$(IFS=,; echo "[${ENVS[*]}]")
          echo "environments=$ENV_JSON" >> $GITHUB_OUTPUT
          echo "run_development=$DEV_CHANGED" >> $GITHUB_OUTPUT
          echo "run_production=$PROD_CHANGED" >> $GITHUB_OUTPUT

          echo "Will run for: $ENV_JSON"

  # Validate terraform for all detected environments
  terraform-validate:
    runs-on: ubuntu-latest
    needs: [detect-environments, get-pr-info]
    if: always() && needs.detect-environments.result == 'success'
    strategy:
      matrix:
        environment: ${{ fromJson(needs.detect-environments.outputs.environments) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.get-pr-info.outputs.ref || github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init (validation only)
        working-directory: environments/${{ matrix.environment }}
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: environments/${{ matrix.environment }}
        run: terraform validate

  # Plan for development environment
  terraform-plan-development:
    runs-on: ubuntu-latest
    needs: [detect-environments, terraform-validate, get-pr-info, check-comment]
    if: always() && needs.terraform-validate.result == 'success' && needs.detect-environments.outputs.run_development == 'true'
    environment: development
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.get-pr-info.outputs.ref || github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.TERRAFORM_SERVICE_ACCOUNT }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Init
        working-directory: environments/development
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: environments/development
        run: |
          terraform plan -no-color -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt
          echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Comment PR with Development Plan
        if: needs.get-pr-info.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('environments/development/plan_output.txt', 'utf8');
            const maxLength = 60000;
            const truncatedPlan = plan.length > maxLength
              ? plan.substring(0, maxLength) + '\n\n... (truncated)'
              : plan;

            const output = `#### üîß Terraform Plan - Development

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${truncatedPlan}
            \`\`\`

            </details>

            *Triggered by: @${{ github.actor }}*

            > Use \`/apply-dev\` to apply this plan to development.`;

            github.rest.issues.createComment({
              issue_number: ${{ needs.get-pr-info.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Upload Development Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-development
          path: environments/development/tfplan

  # Plan for production environment
  terraform-plan-production:
    runs-on: ubuntu-latest
    needs: [detect-environments, terraform-validate, get-pr-info, check-comment]
    if: always() && needs.terraform-validate.result == 'success' && needs.detect-environments.outputs.run_production == 'true'
    environment: production
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.get-pr-info.outputs.ref || github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.TERRAFORM_SERVICE_ACCOUNT }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Init
        working-directory: environments/production
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: environments/production
        run: |
          terraform plan -no-color -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt
          echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Comment PR with Production Plan
        if: needs.get-pr-info.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('environments/production/plan_output.txt', 'utf8');
            const maxLength = 60000;
            const truncatedPlan = plan.length > maxLength
              ? plan.substring(0, maxLength) + '\n\n... (truncated)'
              : plan;

            const output = `#### üöÄ Terraform Plan - Production

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${truncatedPlan}
            \`\`\`

            </details>

            *Triggered by: @${{ github.actor }}*

            > ‚ö†Ô∏è Use \`/apply-prod\` to apply this plan to **PRODUCTION**.`;

            github.rest.issues.createComment({
              issue_number: ${{ needs.get-pr-info.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Upload Production Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-production
          path: environments/production/tfplan

  # Apply to development (on push to main, /apply-dev command, or workflow_dispatch)
  terraform-apply-development:
    runs-on: ubuntu-latest
    needs: [detect-environments, terraform-plan-development, get-pr-info, check-comment]
    if: |
      always() && needs.terraform-plan-development.result == 'success' && (
        (github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.detect-environments.outputs.run_development == 'true') ||
        (github.event_name == 'issue_comment' && needs.check-comment.outputs.command == 'apply' &&
         (needs.check-comment.outputs.environment == 'development' || needs.check-comment.outputs.environment == 'auto')) ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'development' || github.event.inputs.environment == 'both'))
      )
    environment: development
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.get-pr-info.outputs.ref || github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.TERRAFORM_SERVICE_ACCOUNT }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Download Development Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-development
          path: environments/development

      - name: Terraform Init
        working-directory: environments/development
        run: terraform init

      - name: Terraform Apply
        working-directory: environments/development
        run: terraform apply -auto-approve tfplan

      - name: Comment PR with Apply Result
        if: needs.get-pr-info.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ needs.get-pr-info.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `#### üîß Terraform Apply - Development ‚úÖ

              Development infrastructure has been updated successfully!

              *Triggered by: @${{ github.actor }}*`
            });

  # Apply to production (ONLY on explicit /apply-prod command or workflow_dispatch, never auto)
  terraform-apply-production:
    runs-on: ubuntu-latest
    needs: [detect-environments, terraform-plan-production, get-pr-info, check-comment]
    if: |
      always() && needs.terraform-plan-production.result == 'success' && (
        (github.event_name == 'issue_comment' && needs.check-comment.outputs.command == 'apply' &&
         needs.check-comment.outputs.environment == 'production') ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'production' || github.event.inputs.environment == 'both'))
      )
    environment: production
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.get-pr-info.outputs.ref || github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.TERRAFORM_SERVICE_ACCOUNT }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Download Production Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-production
          path: environments/production

      - name: Terraform Init
        working-directory: environments/production
        run: terraform init

      - name: Terraform Apply
        working-directory: environments/production
        run: terraform apply -auto-approve tfplan

      - name: Comment PR with Apply Result
        if: needs.get-pr-info.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ needs.get-pr-info.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `#### üöÄ Terraform Apply - Production ‚úÖ

              **Production infrastructure has been updated successfully!**

              *Triggered by: @${{ github.actor }}*`
            });
