name: Terraform CI/CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'modules/**'
      - 'environments/**'
      - '*.tf'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'modules/**'
      - 'environments/**'
      - '*.tf'
      - '.github/workflows/terraform.yml'
  issue_comment:
    types: [created]
  workflow_dispatch: # Allow manual trigger

concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  TF_VERSION: "1.5.7"

jobs:
  # Check if this is a comment trigger (/plan or /apply)
  check-comment:
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment'
    outputs:
      triggered: ${{ steps.check.outputs.triggered }}
      command: ${{ steps.check.outputs.command }}
    steps:
      - name: Check for /plan or /apply comment
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.trim().toLowerCase();
            const isPR = !!context.payload.issue.pull_request;

            if (!isPR) {
              core.setOutput('triggered', 'false');
              return;
            }

            if (comment === '/plan') {
              core.setOutput('triggered', 'true');
              core.setOutput('command', 'plan');
            } else if (comment === '/apply') {
              core.setOutput('triggered', 'true');
              core.setOutput('command', 'apply');
            } else {
              core.setOutput('triggered', 'false');
            }

  # Get PR ref for comment triggers
  get-pr-ref:
    runs-on: ubuntu-latest
    needs: check-comment
    if: needs.check-comment.outputs.triggered == 'true'
    outputs:
      ref: ${{ steps.get-ref.outputs.ref }}
      base_ref: ${{ steps.get-ref.outputs.base_ref }}
    steps:
      - name: Get PR ref
        id: get-ref
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.issue.number
            });
            core.setOutput('ref', pr.head.ref);
            core.setOutput('base_ref', pr.base.ref);

  determine-environment:
    runs-on: ubuntu-latest
    # Skip for comment events that aren't /plan or /apply
    # For push/pull_request events, check-comment and get-pr-ref are skipped, so use always()
    if: |
      always() && (
        github.event_name != 'issue_comment' ||
        needs.check-comment.outputs.triggered == 'true'
      )
    needs: [check-comment, get-pr-ref]
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      working_directory: ${{ steps.set-env.outputs.working_directory }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          # For comment triggers, use the PR's base branch (not github.ref which is always main)
          # For push events, use github.ref
          # For pull_request events, use github.base_ref
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            TARGET_BRANCH="${{ needs.get-pr-ref.outputs.base_ref }}"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            TARGET_BRANCH="${{ github.ref_name }}"
          else
            TARGET_BRANCH="${{ github.base_ref }}"
          fi

          echo "Target branch: $TARGET_BRANCH"

          if [[ "$TARGET_BRANCH" == "main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "working_directory=environments/production" >> $GITHUB_OUTPUT
          else
            echo "environment=develop" >> $GITHUB_OUTPUT
            echo "working_directory=environments/develop" >> $GITHUB_OUTPUT
          fi

  terraform-validate:
    runs-on: ubuntu-latest
    needs: [determine-environment, check-comment, get-pr-ref]
    if: always() && needs.determine-environment.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # For comment triggers, checkout the PR branch
          ref: ${{ github.event_name == 'issue_comment' && needs.get-pr-ref.outputs.ref || github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init (modules only)
        working-directory: ${{ needs.determine-environment.outputs.working_directory }}
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: ${{ needs.determine-environment.outputs.working_directory }}
        run: terraform validate

  terraform-plan:
    runs-on: ubuntu-latest
    needs: [determine-environment, terraform-validate, check-comment, get-pr-ref]
    if: always() && needs.terraform-validate.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && needs.get-pr-ref.outputs.ref || github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.TERRAFORM_SERVICE_ACCOUNT }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Init
        working-directory: ${{ needs.determine-environment.outputs.working_directory }}
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: ${{ needs.determine-environment.outputs.working_directory }}
        run: |
          terraform plan -no-color -out=tfplan 2>&1 | tee plan_output.txt
        continue-on-error: true

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request' || github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('${{ needs.determine-environment.outputs.working_directory }}/plan_output.txt', 'utf8');
            const maxLength = 65000;
            const truncatedPlan = plan.length > maxLength
              ? plan.substring(0, maxLength) + '\n\n... (truncated)'
              : plan;

            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;

            const output = `#### Terraform Plan - ${{ needs.determine-environment.outputs.environment }}

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${truncatedPlan}
            \`\`\`

            </details>

            *Triggered by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*

            > Comment \`/apply\` to apply this plan.`;

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ needs.determine-environment.outputs.environment }}
          path: ${{ needs.determine-environment.outputs.working_directory }}/tfplan

      - name: Check Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

  terraform-apply:
    runs-on: ubuntu-latest
    needs: [determine-environment, terraform-plan, check-comment, get-pr-ref]
    # Run on push to main/develop OR when /apply comment is made
    if: |
      always() && needs.terraform-plan.result == 'success' && (
        (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')) ||
        (github.event_name == 'issue_comment' && needs.check-comment.outputs.command == 'apply')
      )
    environment: ${{ needs.determine-environment.outputs.environment }}
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && needs.get-pr-ref.outputs.ref || github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.TERRAFORM_SERVICE_ACCOUNT }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ needs.determine-environment.outputs.environment }}
          path: ${{ needs.determine-environment.outputs.working_directory }}

      - name: Terraform Init
        working-directory: ${{ needs.determine-environment.outputs.working_directory }}
        run: terraform init

      - name: Terraform Apply
        working-directory: ${{ needs.determine-environment.outputs.working_directory }}
        run: terraform apply -auto-approve tfplan

      - name: Comment PR with Apply Result
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.issue.number;
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `#### Terraform Apply - ${{ needs.determine-environment.outputs.environment }} âœ…

              Terraform apply completed successfully!

              *Triggered by: @${{ github.actor }}*`
            });
